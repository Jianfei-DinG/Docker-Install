FROM alpine:latest

LABEL maintainer="snowdream <Jianfei@hub.cn.com>"

# 设置时区为上海
RUN set -eu && \
    apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    apk del tzdata

# 覆盖 /etc/apk/repositories 文件内容
RUN echo "http://dl-cdn.alpinelinux.org/alpine/latest-stable/main" | tee /etc/apk/repositories && \
    echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" | tee -a /etc/apk/repositories 

# 安装必要的包
RUN set -eux && \
    apk update && \
    apk add --no-cache bash inotify-tools curl unzip tar

# 创建工作目录
WORKDIR /app

# 复制 tar 文件到容器中
COPY ./docker/xray_configs.tar /app/

# 解压缩 tar 文件到 /etc/nginx 目录中，并删除 tar 文件
RUN tar -xvf /app/xray_configs.tar -C /app/ && rm /app/xray_configs.tar

# 下载并解压 Xray
RUN curl -L -o xray.zip https://github.com/XTLS/Xray-core/releases/download/v1.8.23/Xray-linux-64.zip && \
    unzip -o xray.zip && \
    rm xray.zip

# 设置权限
RUN chmod +x /app/xray.sh /app/xray

# 设置环境变量
ENV CONFIG_DIR=/app/config
ENV LOG_FILE=/app/config/logfile.log
ENV XRAY_EXEC=/app/xray
ENV PID_FILE=/app/xray.pid

# 运行脚本
WORKDIR /app
CMD [ "xray.sh" ]
